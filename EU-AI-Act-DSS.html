<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erweiterter EU AI Act Überlebens-Entscheidungsbaum</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 5px;
            font-size: 24px;
        }
        .subtitle {
            color: #666;
            text-align: center;
            font-style: italic;
            margin-bottom: 30px;
            font-size: 16px;
        }
        .app-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .interaction-area {
            flex: 1;
        }
        .visualization-area {
            flex: 1;
            border-top: 1px dashed #ccc;
            padding-top: 20px;
            min-height: 300px;
        }
        .question-container {
            background-color: #f0f0f0;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 500;
        }
        .cosmic-story {
            background-color: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.5;
        }
        .cosmic-story h3 {
            margin-top: 0;
            color: #333;
            font-size: 20px;
        }
        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        .option {
            padding: 14px 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .yes-option {
            background-color: #e6ffe6;
            color: #006600;
            border: 2px solid #006600;
        }
        .no-option {
            background-color: #ffe6e6;
            color: #660000;
            border: 2px solid #660000;
        }
        .neutral-option {
            background-color: #e6f7ff;
            color: #0066cc;
            border: 2px solid #0066cc;
        }
        .option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .result {
            background-color: #ffe6e6;
            border: 3px solid #cc0000;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
            display: none;
            font-size: 16px;
        }
        .result h2 {
            color: #cc0000;
            margin-top: 0;
            font-size: 22px;
        }
        .endpoint {
            background-color: #e6f7ff;
            border: 2px solid #0066cc;
            border-radius: 8px;
            padding: 18px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
            font-size: 18px;
        }
        .restart-btn {
            background-color: #333;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 12px 18px;
            cursor: pointer;
            display: block;
            margin: 20px auto 0;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .restart-btn:hover {
            background-color: #555;
        }
        .footnote {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-top: 30px;
            font-style: italic;
        }
        
        /* Visualisierungsbereich Styles */
        #tree-visualization {
            width: 100%;
            height: 100%;
            overflow: auto;
        }
        .node {
            fill: #fff;
            stroke: #333;
            stroke-width: 2px;
        }
        .node-visited {
            fill: #e6f7ff;
        }
        .node-current {
            fill: #ffe6e6;
            stroke: #cc0000;
            stroke-width: 3px;
        }
        .node-text {
            font-size: 12px; /* Vergrößert für bessere Lesbarkeit */
            text-anchor: middle;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        .node-enlarged .node-text {
            font-size: 16px;
            font-weight: bold;
        }
        .popup-info {
            fill: white;
            stroke: #333;
            stroke-width: 1px;
            rx: 5;
            ry: 5;
            opacity: 0.95;
            filter: drop-shadow(0px 3px 3px rgba(0,0,0,0.2));
        }
        .popup-text {
            font-size: 14px;
            fill: #333;
        }
        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
        }
        .link-visited {
            stroke: #333;
        }
        .vis-section-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        /* Responsive Design */
        @media (min-width: 768px) {
            .app-container {
                flex-direction: row;
            }
            .interaction-area {
                width: 50%;
            }
            .visualization-area {
                width: 50%;
                border-top: none;
                border-left: 1px dashed #ccc;
                padding-top: 0;
                padding-left: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Der offizielle EU AI Act Überlebens-Entscheidungsbaum</h1>
        <p class="subtitle">(oder: Wie du durch die Galaxie der Bürokratie navigierst ohne deinen Verstand zu verlieren)</p>
        
        <div class="app-container">
            <div class="interaction-area">
                <div id="game-container">
                    <!-- Hier wird der dynamische Inhalt eingefügt -->
                </div>
                
                <div id="result" class="result">
                    <h2>BUCHE JETZT DEN KHAOS EU AI ACT KURS!</h2>
                    <p>Herzlichen Glückwunsch! Du hast den einzig logischen Ausweg aus dem bürokratischen Labyrinth gefunden.</p>
                    <button id="restart-btn" class="restart-btn">Nochmal spielen</button>
                </div>
            </div>
            
            <div class="visualization-area">
                <p class="vis-section-header">Deine Reise durch den EU AI Act:</p>
                <div id="tree-visualization">
                    <!-- Hier wird die Baumvisualisierung gerendert -->
                </div>
            </div>
        </div>
        
        <p class="footnote">*Hinweis: Egal welche Antworten du wählst, du brauchst diesen Kurs.<br>Es ist, als hätte das Schicksal (oder ein übermäßig sarkastischer Programmier-Guru) es so gewollt.</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Spielzustände
            const gameStates = {
                q1: {
                    type: 'question',
                    content: `<div class="cosmic-story" style="margin-bottom: 20px;">
                        <h3>Die kosmische Geschichte des EU AI Acts</h3>
                        <p>1. Das Universum wurde erschaffen, was viele Leute sehr ärgerlich machte und im Allgemeinen für keine gute Idee befunden wurde.</p>
                        <p>2. Unsere Vorfahren stiegen von den Bäumen, erschufen kurz danach Feuer, Rad und den Eingangsstempel der Behörden.</p>
                        <p>3. Dies besorgte mächtige Bürger so sehr, dass sie im Jahr 2024 den EU AI Act erschufen.</p>
                    </div>
                    <div>Bist du ein Hochrisiko-AI-System Hersteller?</div>`,
                    displayName: 'Hochrisiko-Hersteller?',
                    options: [
                        { text: 'Ja', nextState: 'e1', class: 'yes-option' },
                        { text: 'Nein / Keine Ahnung', nextState: 'q2', class: 'no-option' }
                    ]
                },
                e1: {
                    type: 'endpoint',
                    content: 'Hau ab! Hier bist du falsch. Viel Spaß mit deinen Anwälten.',
                    displayName: 'Anwälte-Endstation',
                    options: [
                        { text: 'Oh... Weiter geht\'s', nextState: 'result', class: 'neutral-option' }
                    ]
                },
                q2: {
                    type: 'question',
                    content: 'Möchtest du dein Geschäft behalten?',
                    displayName: 'Geschäft behalten?',
                    options: [
                        { text: 'Ja', nextState: 'q3', class: 'yes-option' },
                        { text: 'Nein', nextState: 'e2', class: 'no-option' }
                    ]
                },
                e2: {
                    type: 'endpoint',
                    content: 'Na, dann brauchst du unseren Kurs erst recht!',
                    displayName: 'Kein Geschäft',
                    options: [
                        { text: 'Einleuchtend. Weiter.', nextState: 'result', class: 'neutral-option' }
                    ]
                },
                q3: {
                    type: 'question',
                    content: 'Planst du KI zu verwenden oder verwendest sie bereits?',
                    displayName: 'KI verwenden?',
                    options: [
                        { text: 'Ja', nextState: 'q4', class: 'yes-option' },
                        { text: 'Nein', nextState: 'q3b', class: 'no-option' }
                    ]
                },
                q3b: {
                    type: 'question',
                    content: 'Lebst du unter einem Stein?',
                    displayName: 'Unter einem Stein?',
                    options: [
                        { text: 'Ja', nextState: 'e3', class: 'yes-option' },
                        { text: 'Natürlich nicht!', nextState: 'q_vision', class: 'no-option' }
                    ]
                },
                e3: {
                    type: 'endpoint',
                    content: 'Riskant! Die Konkurrenz nutzt KI längst.',
                    displayName: 'Steinbewohner',
                    options: [
                        { text: 'Ups. Weiter.', nextState: 'q_vision', class: 'neutral-option' }
                    ]
                },
                q4: {
                    type: 'question',
                    content: 'Verstehst du die EU AI Act Compliance-Anforderungen?',
                    displayName: 'Compliance verstehen?',
                    options: [
                        { text: 'Ja klar!', nextState: 'e4', class: 'yes-option' },
                        { text: 'Nein / Bin verwirrt', nextState: 'q_management', class: 'no-option' }
                    ]
                },
                e4: {
                    type: 'endpoint',
                    content: 'Guter Versuch! Aber niemand versteht sie.',
                    displayName: 'Niemand versteht es',
                    options: [
                        { text: 'Erwischt. Weiter.', nextState: 'q_management', class: 'neutral-option' }
                    ]
                },
                // Neue Verzweigungen
                q_vision: {
                    type: 'question',
                    content: 'Wie stellst du dir die KI-Zukunft vor?',
                    displayName: 'KI-Zukunftsvision',
                    options: [
                        { text: 'Roboter-Utopie', nextState: 'e_vision1', class: 'yes-option' },
                        { text: 'KI-Apokalypse', nextState: 'e_vision2', class: 'no-option' },
                        { text: 'Arbeitslos durch KI', nextState: 'e_vision3', class: 'neutral-option' }
                    ]
                },
                e_vision1: {
                    type: 'endpoint',
                    content: 'Süß, wie naiv. Aber bevor die Roboter uns dienen, müssen wir erst die EU-Compliance erfüllen.',
                    displayName: 'Naive Utopie',
                    options: [
                        { text: 'Das leuchtet ein. Weiter.', nextState: 'q_management', class: 'neutral-option' }
                    ]
                },
                e_vision2: {
                    type: 'endpoint',
                    content: 'Keine Sorge, die EU-Bürokratie wird die Maschinen aufhalten, bevor sie die Weltherrschaft übernehmen können.',
                    displayName: 'Bürokratie > Skynet',
                    options: [
                        { text: 'Beruhigend. Weiter.', nextState: 'q_management', class: 'neutral-option' }
                    ]
                },
                e_vision3: {
                    type: 'endpoint',
                    content: 'Na immerhin hast du dann Zeit für unseren Kurs!',
                    displayName: 'Zeit für den Kurs',
                    options: [
                        { text: 'Da ist was dran. Weiter.', nextState: 'q_management', class: 'neutral-option' }
                    ]
                },
                q_management: {
                    type: 'question',
                    content: 'Wie hat dein Management auf den EU AI Act reagiert?',
                    displayName: 'Management-Reaktion',
                    options: [
                        { text: 'Mit Panik', nextState: 'e_mgmt1', class: 'no-option' },
                        { text: 'Mit Ignoranz', nextState: 'e_mgmt2', class: 'neutral-option' },
                        { text: 'Mit strategischer Planung', nextState: 'e_mgmt3', class: 'yes-option' }
                    ]
                },
                e_mgmt1: {
                    type: 'endpoint',
                    content: 'Klassisch! Panik ist immer die erste Reaktion auf EU-Verordnungen. Fast so zuverlässig wie die deutsche Bahn unpünktlich ist.',
                    displayName: 'Deutsche Bahn der Compliance',
                    options: [
                        { text: 'Leider wahr. Weiter.', nextState: 'q_implementation', class: 'neutral-option' }
                    ]
                },
                e_mgmt2: {
                    type: 'endpoint',
                    content: 'Die Strategie "Kopf in den Sand" - funktioniert hervorragend, bis die ersten Bußgelder kommen.',
                    displayName: 'Kopf im Sand',
                    options: [
                        { text: 'Wird teuer. Weiter.', nextState: 'q_implementation', class: 'neutral-option' }
                    ]
                },
                e_mgmt3: {
                    type: 'endpoint',
                    content: 'Du lügst! Niemand plant strategisch für EU-Regularien. Das ist wie Vorbereitungen für eine Alien-Invasion.',
                    displayName: 'Alien-Invasion',
                    options: [
                        { text: 'Erwischt. Weiter.', nextState: 'q_implementation', class: 'neutral-option' }
                    ]
                },
                q_implementation: {
                    type: 'question',
                    content: 'Wie planst du die Compliance-Anforderungen umzusetzen?',
                    displayName: 'Umsetzungsplan',
                    options: [
                        { text: 'Excel-Tabelle', nextState: 'e_impl1', class: 'no-option' },
                        { text: 'Ein internes Team beauftragen', nextState: 'e_impl2', class: 'neutral-option' },
                        { text: 'Externe Berater engagieren', nextState: 'e_impl3', class: 'yes-option' }
                    ]
                },
                e_impl1: {
                    type: 'endpoint',
                    content: 'Ah, die universelle Lösung für alles. Warum nicht gleich eine PowerPoint-Präsentation mit Comic Sans?',
                    displayName: 'Excel vs. AI Act',
                    options: [
                        { text: 'Comic Sans wäre besser. Weiter.', nextState: 'q5', class: 'neutral-option' }
                    ]
                },
                e_impl2: {
                    type: 'endpoint',
                    content: 'Perfekt! Nichts schreit "Erfolg" wie ein überarbeitetes Team ohne Expertise.',
                    displayName: 'Überarbeitetes Team',
                    options: [
                        { text: 'Die Armen. Weiter.', nextState: 'q5', class: 'neutral-option' }
                    ]
                },
                e_impl3: {
                    type: 'endpoint',
                    content: 'Klassiker! Deren Expertise besteht hauptsächlich darin, dein Budget in ihre Taschen zu befördern.',
                    displayName: 'Budget-Transfer-Experten',
                    options: [
                        { text: 'Teures Vergnügen. Weiter.', nextState: 'q5', class: 'neutral-option' }
                    ]
                },
                q5: {
                    type: 'question',
                    content: 'Mögen deine Mitarbeiter Bürokratie und endlose Compliance-Meetings?',
                    displayName: 'Bürokratie-Liebe?',
                    options: [
                        { text: 'Ja, total!', nextState: 'e5', class: 'yes-option' },
                        { text: 'Nein', nextState: 'q6', class: 'no-option' }
                    ]
                },
                e5: {
                    type: 'endpoint',
                    content: 'Lügner!',
                    displayName: 'Lügner!',
                    options: [
                        { text: 'Okay, okay. Weiter.', nextState: 'q6', class: 'neutral-option' }
                    ]
                },
                q6: {
                    type: 'question',
                    content: 'Möchtest du eine einfache, effektive Lösung, die deine Konkurrenz grün vor Neid werden lässt?',
                    displayName: 'Konkurrenz-Vorteil?',
                    options: [
                        { text: 'Definitiv!', nextState: 'result', class: 'yes-option' },
                        { text: 'Wer würde das nicht wollen?', nextState: 'result', class: 'neutral-option' }
                    ]
                },
                result: {
                    type: 'end',
                    content: '',
                    displayName: 'KHAOS Kurs!'
                }
            };

            // Baum-Visualisierungsdaten
            const treeData = {
                nodes: [
                    // Kein Startknoten mehr, direkt mit q1 beginnen
                    { id: 'q1', x: 400, y: 50, label: 'Start' }
                ],
                links: []
            };
            
            // Besuchspfad für die Visualisierung
            let visitedPath = [];
            let currentState = 'q1'; // Direkt mit q1 starten
            visitedPath.push(currentState);
            
            // DOM-Elemente
            const gameContainer = document.getElementById('game-container');
            const resultElement = document.getElementById('result');
            const restartBtn = document.getElementById('restart-btn');
            const treeVisualization = document.getElementById('tree-visualization');
            
            // Koordinatenberechnung für Baumknoten mit verbesserten Abständen
            function calculateNodePosition(stateId) {
                // Feststellen, wo wir im Baum sind
                const levels = {
                    'q1': 0, // q1 ist jetzt der Startpunkt
                    'e1': 1, 'q2': 1,
                    'e2': 2, 'q3': 2,
                    'q3b': 3, 'q4': 3,
                    'e3': 4, 'e4': 4, 'q_vision': 4, 'q_management': 4,
                    'e_vision1': 5, 'e_vision2': 5, 'e_vision3': 5, 'e_mgmt1': 5, 'e_mgmt2': 5, 'e_mgmt3': 5,
                    'q_implementation': 6,
                    'e_impl1': 7, 'e_impl2': 7, 'e_impl3': 7,
                    'q5': 8,
                    'e5': 9, 'q6': 9,
                    'result': 10
                };
                
                // Horizontale Position basierend auf ID (verbessert für bessere Platzierung)
                const horizontalPositions = {
                    'q1': 400,
                    'e1': 600, 'q2': 400,
                    'e2': 600, 'q3': 400,
                    'q3b': 500, 'q4': 300,
                    'e3': 550, 'e4': 250, 'q_vision': 500, 'q_management': 300,
                    'e_vision1': 425, 'e_vision2': 500, 'e_vision3': 575, 'e_mgmt1': 225, 'e_mgmt2': 300, 'e_mgmt3': 375,
                    'q_implementation': 300,
                    'e_impl1': 225, 'e_impl2': 300, 'e_impl3': 375,
                    'q5': 300,
                    'e5': 400, 'q6': 300,
                    'result': 400
                };
                
                const level = levels[stateId] || 0;
                const x = horizontalPositions[stateId] || 400;
                const y = 50 + level * 70; // Größerer vertikaler Abstand für bessere Lesbarkeit
                
                return { x, y };
            }
            
            // Bessere Baumvisualisierung mit verbesserten Knotendarstellungen
            function renderTree() {
                // SVG-Element erstellen oder leeren
                treeVisualization.innerHTML = '';
                const svgNS = "http://www.w3.org/2000/svg";
                const svg = document.createElementNS(svgNS, "svg");
                svg.setAttribute("width", "100%");
                svg.setAttribute("height", "700"); // Anpassen nach Bedarf
                svg.setAttribute("viewBox", "0 0 800 750"); // Mehr vertikalen Raum
                treeVisualization.appendChild(svg);
                
                // Verbindungslinien zeichnen
                treeData.links.forEach(link => {
                    const line = document.createElementNS(svgNS, "path");
                    const sourceNode = treeData.nodes.find(n => n.id === link.source);
                    const targetNode = treeData.nodes.find(n => n.id === link.target);
                    
                    if (sourceNode && targetNode) {
                        // Verbesserte Kurvenberechnung für glattere Linien
                        const path = `M${sourceNode.x},${sourceNode.y} C${sourceNode.x},${(sourceNode.y + targetNode.y) / 2} ${targetNode.x},${(sourceNode.y + targetNode.y) / 2} ${targetNode.x},${targetNode.y}`;
                        line.setAttribute("d", path);
                        line.setAttribute("class", `link ${visitedPath.includes(link.source) && visitedPath.includes(link.target) ? 'link-visited' : ''}`);
                        svg.appendChild(line);
                    }
                });
                
                // Knoten zeichnen mit verbesserter Darstellung
                treeData.nodes.forEach(node => {
                    const nodeGroup = document.createElementNS(svgNS, "g");
                    nodeGroup.setAttribute("transform", `translate(${node.x},${node.y})`);
                    
                    // Größerer Kreis für bessere Sichtbarkeit
                    const circle = document.createElementNS(svgNS, "circle");
                    circle.setAttribute("r", "30"); // Größer für bessere Lesbarkeit
                    circle.setAttribute("cursor", "pointer");
                    if (node.id === currentState) {
                        circle.setAttribute("class", "node node-current");
                    } else if (visitedPath.includes(node.id)) {
                        circle.setAttribute("class", "node node-visited");
                    } else {
                        circle.setAttribute("class", "node");
                    }
                    nodeGroup.appendChild(circle);
                    
                    // Verbesserte Textdarstellung in mehreren Zeilen
                    const state = gameStates[node.id];
                    let textElements = [];
                    
                    if (state && state.displayName) {
                        // Text splitten für bessere Lesbarkeit
                        const words = state.displayName.split(' ');
                        
                        if (words.length > 1) {
                            // Text in zwei Zeilen darstellen, falls mehrere Wörter
                            const firstLine = document.createElementNS(svgNS, "text");
                            firstLine.setAttribute("y", "-6"); // Höher positioniert
                            firstLine.setAttribute("class", "node-text");
                            firstLine.setAttribute("font-weight", "bold"); // Fetter Text für bessere Lesbarkeit
                            firstLine.textContent = words.slice(0, Math.ceil(words.length/2)).join(' ');
                            nodeGroup.appendChild(firstLine);
                            textElements.push(firstLine);
                            
                            const secondLine = document.createElementNS(svgNS, "text");
                            secondLine.setAttribute("y", "12"); // Mehr Abstand
                            secondLine.setAttribute("class", "node-text");
                            secondLine.setAttribute("font-weight", "bold"); // Fetter Text für bessere Lesbarkeit
                            secondLine.textContent = words.slice(Math.ceil(words.length/2)).join(' ');
                            nodeGroup.appendChild(secondLine);
                            textElements.push(secondLine);
                        } else {
                            // Einfacher Text, wenn nur ein Wort
                            const text = document.createElementNS(svgNS, "text");
                            text.setAttribute("y", "5");
                            text.setAttribute("class", "node-text");
                            text.setAttribute("font-weight", "bold"); // Fetter Text für bessere Lesbarkeit
                            text.textContent = state.displayName;
                            nodeGroup.appendChild(text);
                            textElements.push(text);
                        }
                        
                        // Event-Listener für Knoten-Klick mit verbessertem Popup
                        const toggleEnlarged = () => {
                            const isEnlarged = nodeGroup.classList.contains('node-enlarged');
                            
                            // Alle anderen Popups schließen
                            document.querySelectorAll('.popup-group').forEach(popup => {
                                popup.parentNode.removeChild(popup);
                            });
                            document.querySelectorAll('.node-enlarged').forEach(node => {
                                node.classList.remove('node-enlarged');
                            });
                            
                            if (!isEnlarged) {
                                nodeGroup.classList.add('node-enlarged');
                                
                                // Füge ein verbessertes Popup mit mehr Details hinzu
                                if (state.content) {
                                    const popupGroup = document.createElementNS(svgNS, "g");
                                    popupGroup.setAttribute("class", "popup-group");
                                    
                                    // Verbesserter Hintergrund mit Schatten
                                    const popupBg = document.createElementNS(svgNS, "rect");
                                    popupBg.setAttribute("x", "35");
                                    popupBg.setAttribute("y", "-40");
                                    popupBg.setAttribute("width", "250"); // Breiter für mehr Text
                                    popupBg.setAttribute("height", "90"); // Höher für mehr Text
                                    popupBg.setAttribute("class", "popup-info");
                                    popupGroup.appendChild(popupBg);
                                    
                                    // Inhalt kürzen falls nötig
                                    let shortContent = state.content;
                                    if (shortContent.length > 140) { // Mehr Zeichen erlauben
                                        shortContent = shortContent.substring(0, 137) + '...';
                                    }
                                    
                                    // Text in mehreren Zeilen mit verbesserter Formatierung
                                    const words = shortContent.split(' ');
                                    let lines = [];
                                    let currentLine = '';
                                    
                                    words.forEach(word => {
                                        if ((currentLine + word).length > 30) { // Breitere Zeilen
                                            lines.push(currentLine);
                                            currentLine = word + ' ';
                                        } else {
                                            currentLine += word + ' ';
                                        }
                                    });
                                    if (currentLine.length > 0) {
                                        lines.push(currentLine);
                                    }
                                    
                                    // Text darstellen
                                    lines.forEach((line, index) => {
                                        const popupText = document.createElementNS(svgNS, "text");
                                        popupText.setAttribute("x", "45");
                                        popupText.setAttribute("y", (-25 + index * 20).toString()); // Mehr Abstand zwischen Zeilen
                                        popupText.setAttribute("class", "popup-text");
                                        popupText.textContent = line;
                                        popupGroup.appendChild(popupText);
                                    });
                                    
                                    // Schließen-Button hinzufügen
                                    const closeButton = document.createElementNS(svgNS, "circle");
                                    closeButton.setAttribute("cx", "280");
                                    closeButton.setAttribute("cy", "-35");
                                    closeButton.setAttribute("r", "10");
                                    closeButton.setAttribute("fill", "#ff6666");
                                    closeButton.setAttribute("stroke", "#cc0000");
                                    closeButton.setAttribute("cursor", "pointer");
                                    closeButton.onclick = () => {
                                        nodeGroup.removeChild(popupGroup);
                                        nodeGroup.classList.remove('node-enlarged');
                                    };
                                    popupGroup.appendChild(closeButton);
                                    
                                    // X im Schließen-Button
                                    const closeX = document.createElementNS(svgNS, "text");
                                    closeX.setAttribute("x", "280");
                                    closeX.setAttribute("y", "-31");
                                    closeX.setAttribute("text-anchor", "middle");
                                    closeX.setAttribute("font-size", "12px");
                                    closeX.setAttribute("fill", "white");
                                    closeX.setAttribute("font-weight", "bold");
                                    closeX.setAttribute("pointer-events", "none");
                                    closeX.textContent = "×";
                                    popupGroup.appendChild(closeX);
                                    
                                    nodeGroup.appendChild(popupGroup);
                                }
                            }
                        };
                        
                        // Event-Listener hinzufügen
                        circle.addEventListener('click', toggleEnlarged);
                        textElements.forEach(el => {
                            el.addEventListener('click', toggleEnlarged);
                        });
                    }
                    
                    svg.appendChild(nodeGroup);
                });
                
                // Größenanpassung und Message an das übergeordnete iframe
                sendResizeMessage();
            }
            
            // Aktualisieren der Visualisierung bei Zustandsänderung
            function updateVisualization(newStateId) {
                const state = gameStates[newStateId];
                if (!state) return;
                
                // Aktuellen Zustand aktualisieren
                currentState = newStateId;
                visitedPath.push(newStateId);
                
                // Prüfen, ob der Knoten bereits existiert
                if (!treeData.nodes.some(node => node.id === newStateId)) {
                    const position = calculateNodePosition(newStateId);
                    treeData.nodes.push({
                        id: newStateId,
                        x: position.x,
                        y: position.y,
                        label: state.displayName || newStateId
                    });
                    
                    // Verbindung zum vorherigen Zustand hinzufügen, wenn nicht der Startzustand
                    if (visitedPath.length > 1) {
                        const previousStateId = visitedPath[visitedPath.length - 2];
                        treeData.links.push({
                            source: previousStateId,
                            target: newStateId
                        });
                    }
                }
                
                // Optionen für den aktuellen Zustand
                if (state.options) {
                    state.options.forEach(option => {
                        // Für jede Option prüfen, ob der Zielzustand bereits als Knoten existiert
                        if (!treeData.nodes.some(node => node.id === option.nextState)) {
                            const targetState = gameStates[option.nextState];
                            if (targetState) {
                                const position = calculateNodePosition(option.nextState);
                                treeData.nodes.push({
                                    id: option.nextState,
                                    x: position.x,
                                    y: position.y,
                                    label: targetState.displayName || option.nextState
                                });
                            }
                        }
                        
                        // Verbindung hinzufügen, wenn sie noch nicht existiert
                        if (!treeData.links.some(link => link.source === newStateId && link.target === option.nextState)) {
                            treeData.links.push({
                                source: newStateId,
                                target: option.nextState
                            });
                        }
                    });
                }
                
                // Baum neu zeichnen
                renderTree();
            }
            
            // Spielzustand rendern mit verbesserter Animation
            function renderState(stateName) {
                const state = gameStates[stateName];
                if (!state) return;
                
                // Fade-out Effekt
                gameContainer.style.opacity = '0';
                gameContainer.style.transition = 'opacity 0.3s';
                
                setTimeout(() => {
                    gameContainer.innerHTML = '';
                    
                    // Container erstellen je nach Zustandstyp
                    const container = document.createElement('div');
                    container.className = state.type === 'cosmic-story' ? 'cosmic-story' : 
                                          state.type === 'endpoint' ? 'endpoint' : 'question-container';
                    
                    // Inhalt einfügen
                    container.innerHTML = state.content;
                    
                    // Optionen hinzufügen, falls vorhanden
                    if (state.options && state.options.length > 0) {
                        const optionsContainer = document.createElement('div');
                        optionsContainer.className = 'options';
                        
                        state.options.forEach(option => {
                            const button = document.createElement('button');
                            button.textContent = option.text;
                            button.className = `option ${option.class || 'neutral-option'}`;
                            button.addEventListener('click', () => {
                                // Baum-Visualisierung aktualisieren
                                updateVisualization(option.nextState);
                                
                                if (option.nextState === 'result') {
                                    gameContainer.style.display = 'none';
                                    resultElement.style.display = 'block';
                                } else {
                                    renderState(option.nextState);
                                }
                            });
                            optionsContainer.appendChild(button);
                        });
                        
                        container.appendChild(optionsContainer);
                    }
                    
                    gameContainer.appendChild(container);
                    
                    // Fade-in Effekt
                    setTimeout(() => {
                        gameContainer.style.opacity = '1';
                    }, 50);
                }, 300);
            }

            // Neustart-Funktion mit verbesserter UX
            restartBtn.addEventListener('click', () => {
                // Fade-Effekte für sanftere Übergänge
                resultElement.style.opacity = '0';
                resultElement.style.transition = 'opacity 0.3s';
                
                setTimeout(() => {
                    gameContainer.style.display = 'block';
                    gameContainer.style.opacity = '0';
                    resultElement.style.display = 'none';
                    
                    // Zurücksetzen
                    visitedPath = ['q1']; // Direkt mit q1 starten
                    currentState = 'q1';
                    treeData.nodes = [{ id: 'q1', x: 400, y: 50, label: 'Start' }];
                    treeData.links = [];
                    
                    renderTree();
                    renderState(currentState);
                    
                    setTimeout(() => {
                        gameContainer.style.opacity = '1';
                    }, 50);
                }, 300);
            });
            
            // Größenanpassungs-Nachricht senden
            function sendResizeMessage() {
                const height = document.body.scrollHeight;
                window.parent.postMessage({
                    type: 'resize',
                    height: height
                }, '*');
            }

            // Spiel initialisieren - direkt mit q1, ohne Dialog
            updateVisualization(currentState);
            renderState(currentState);
            
            // Event-Listener für Fenstergröße
            window.addEventListener("resize", () => {
                renderTree(); // Nur den Baum neu zeichnen, nicht das ganze Spiel
            });
            
            // Automatische Anpassung der SVG-Höhe nach vollständigem Laden
            setTimeout(() => {
                sendResizeMessage();
            }, 500);
        });
    </script>
</body>
</html>