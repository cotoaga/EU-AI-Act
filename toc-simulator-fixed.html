<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theory of Constraints: Alex Rogo's Boy Scout Hike</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background: #ffffff;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        
        .theory-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .theory-box h3 {
            margin-top: 0;
            font-size: 1.4em;
            color: #ffffff;
        }
        
        .simulation-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .scout-profiles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .scout-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 5px solid;
        }
        
        .scout-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }
        
        .scout-card.herbie {
            border-left-color: #e74c3c;
        }
        
        .scout-card.dave {
            border-left-color: #3498db;
        }
        
        .scout-card.sean {
            border-left-color: #f39c12;
        }
        
        .scout-card.ron {
            border-left-color: #27ae60;
        }
        
        .scout-name {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .scout-icon {
            font-size: 3em;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .herbie .scout-icon { color: #e74c3c; }
        .dave .scout-icon { color: #3498db; }
        .sean .scout-icon { color: #f39c12; }
        .ron .scout-icon { color: #27ae60; }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #34495e;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .sim-parameters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .button-container {
            text-align: center;
            margin: 30px 0;
        }
        
        .run-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .run-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .results-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .results-table {
            overflow-x: auto;
            margin-bottom: 30px;
        }
        
        .results-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        
        .results-table th,
        .results-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #e1e8ed;
        }
        
        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        
        .results-table tr:hover {
            background: #f8f9fa;
        }
        
        .chart-container {
            margin-top: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        #simChart {
            max-width: 100% !important;
            max-height: 400px !important;
            width: 100% !important;
            height: 400px !important;
        }
        
        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        #modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
        }
        
        #modal-content pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
        }
        
        #modal-content button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
            width: 100%;
        }
        
        .insights {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
        }
        
        .insights h3 {
            margin-top: 0;
            color: #8b4513;
        }
        
        .insights ul {
            list-style-type: none;
            padding-left: 0;
        }
        
        .insights li {
            margin-bottom: 10px;
            padding-left: 25px;
            position: relative;
        }
        
        .insights li:before {
            content: "💡";
            position: absolute;
            left: 0;
        }
        
        .constraint-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .bottleneck-badge {
            background: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
        
        /* Drum-Buffer Visualization Styles */
        .dbr-visualization {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .dbr-controls {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .dbr-toggle {
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .dbr-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(142, 68, 173, 0.4);
        }
        
        .drum-section {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 30px;
            align-items: center;
        }
        
        .drum-display {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #e74c3c;
        }
        
        .drum-icon {
            font-size: 4em;
            color: #e74c3c;
            margin-bottom: 10px;
            display: block;
        }
        
        .drum-beat {
            animation: drumPulse 2s infinite ease-in-out;
        }
        
        @keyframes drumPulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.15); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        
        .drum-metrics {
            background: white;
            padding: 15px;
            border-radius: 10px;
        }
        
        .metric-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .buffer-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #3498db;
        }
        
        .buffer-visualization {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .scout-buffer {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .scout-buffer.herbie {
            background: linear-gradient(135deg, #e74c3c20, #e74c3c40);
            border: 2px solid #e74c3c;
        }
        
        .scout-buffer.normal {
            background: linear-gradient(135deg, #3498db20, #3498db40);
            border: 2px solid #3498db;
        }
        
        .buffer-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            position: relative;
        }
        
        .buffer-fill {
            height: 100%;
            transition: all 0.5s ease;
            border-radius: 10px;
        }
        
        .buffer-fill.healthy {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }
        
        .buffer-fill.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .buffer-fill.critical {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .buffer-label {
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        @media (max-width: 768px) {
            .simulation-controls {
                grid-template-columns: 1fr;
            }
            
            .scout-profiles {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏃‍♂️ Theory of Constraints Simulator</h1>
            <div class="subtitle">Alex Rogo's Boy Scout Hike from "The Goal"</div>
            <div class="theory-box">
                <h3>🎯 The Lesson: Understanding System Constraints</h3>
                <p>In this famous scene from Eli Goldratt's "The Goal," Alex Rogo discovers that a system's throughput is limited by its slowest component. No matter how fast the other scouts move, the entire group can only go as fast as Herbie, the bottleneck. This fundamental insight revolutionizes how we think about process optimization.</p>
            </div>
        </div>

        <div class="simulation-controls">
            <div class="control-panel">
                <h3>🎛️ Simulation Parameters</h3>
                <div class="sim-parameters">
                    <div class="form-group">
                        <label for="sim_steps">🔄 Simulation Length (steps):</label>
                        <input type="number" id="sim_steps" value="25" min="5" max="100">
                    </div>
                    <div class="form-group">
                        <label for="min_gap">📏 Minimum Gap (meters):</label>
                        <input type="number" id="min_gap" step="0.1" value="1.0" min="0.1" max="5">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="debug_mode" style="width: auto; margin-right: 10px;">
                            🔍 Debug Mode (Step-by-step analysis)
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="control-panel">
                <h3>📊 Understanding the Parameters</h3>
                <div style="color: #666;">
                    <p><strong>Average Speed:</strong> Each scout's typical hiking pace (km/h)</p>
                    <p><strong>Standard Deviation:</strong> Variability in performance (higher = more inconsistent)</p>
                    <p><strong>Starting Position:</strong> Where each scout begins on the trail</p>
                    <p><strong>Minimum Gap:</strong> Safety distance scouts must maintain</p>
                </div>
            </div>
        </div>

        <div class="scout-profiles">
            <div class="scout-card herbie">
                <div class="scout-icon">🐌</div>
                <div class="scout-name">
                    Herbie <span class="bottleneck-badge">BOTTLENECK</span>
                </div>
                <div class="form-group">
                    <label>Average Speed (km/h):</label>
                    <input type="number" id="herbie_avg" step="0.1" value="4.0" min="1" max="10">
                </div>
                <div class="form-group">
                    <label>Variability (std dev):</label>
                    <input type="number" id="herbie_std" step="0.1" value="0.8" min="0.1" max="3">
                </div>
                <div class="form-group">
                    <label>Starting Position (m):</label>
                    <input type="number" id="herbie_start" value="0" min="0" max="20">
                </div>
            </div>

            <div class="scout-card dave">
                <div class="scout-icon">🚶</div>
                <div class="scout-name">Dave</div>
                <div class="form-group">
                    <label>Average Speed (km/h):</label>
                    <input type="number" id="dave_avg" step="0.1" value="5.5" min="1" max="10">
                </div>
                <div class="form-group">
                    <label>Variability (std dev):</label>
                    <input type="number" id="dave_std" step="0.1" value="0.5" min="0.1" max="3">
                </div>
                <div class="form-group">
                    <label>Starting Position (m):</label>
                    <input type="number" id="dave_start" value="3" min="0" max="20">
                </div>
            </div>

            <div class="scout-card sean">
                <div class="scout-icon">🏃</div>
                <div class="scout-name">Sean</div>
                <div class="form-group">
                    <label>Average Speed (km/h):</label>
                    <input type="number" id="sean_avg" step="0.1" value="6.0" min="1" max="10">
                </div>
                <div class="form-group">
                    <label>Variability (std dev):</label>
                    <input type="number" id="sean_std" step="0.1" value="0.6" min="0.1" max="3">
                </div>
                <div class="form-group">
                    <label>Starting Position (m):</label>
                    <input type="number" id="sean_start" value="6" min="0" max="20">
                </div>
            </div>

            <div class="scout-card ron">
                <div class="scout-icon">🏃‍♂️</div>
                <div class="scout-name">Ron</div>
                <div class="form-group">
                    <label>Average Speed (km/h):</label>
                    <input type="number" id="ron_avg" step="0.1" value="6.2" min="1" max="10">
                </div>
                <div class="form-group">
                    <label>Variability (std dev):</label>
                    <input type="number" id="ron_std" step="0.1" value="0.7" min="0.1" max="3">
                </div>
                <div class="form-group">
                    <label>Starting Position (m):</label>
                    <input type="number" id="ron_start" value="9" min="0" max="20">
                </div>
            </div>
        </div>

        <div class="button-container">
            <button class="run-button" id="runSim">🚀 Start Scout Hike Simulation</button>
            <button class="run-button" id="putHerbieFirst" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); margin-left: 20px;">🎯 Put Herbie in Front (ToC Solution)</button>
            <button class="dbr-toggle" id="dbrToggle" style="margin-left: 20px;">🥁 Enable Drum-Buffer Visualization</button>
        </div>

        <div class="dbr-visualization" id="dbrVisualization">
            <div style="text-align: center; margin-bottom: 20px;">
                <p style="margin: 10px 0; color: #666; font-size: 0.9em;">
                    Visualize the system's drum (constraint pace) and buffer (safety zones) in real-time
                </p>
            </div>
            
            <div id="dbrContent" style="display: none;">
                <div class="drum-section">
                    <div class="drum-display">
                        <span class="drum-icon" id="drumIcon">🥁</span>
                        <h4 style="margin: 0; color: #e74c3c;">System Drum</h4>
                        <p style="margin: 5px 0; font-size: 0.9em; color: #666;">Herbie's Pace Sets the Beat</p>
                    </div>
                    
                    <div class="drum-metrics">
                        <h4 style="margin-top: 0; color: #2c3e50;">🎵 Drum Metrics</h4>
                        <div class="metric-item">
                            <span>Current Drum Beat:</span>
                            <span id="drumBeat" style="font-weight: bold; color: #e74c3c;">-</span>
                        </div>
                        <div class="metric-item">
                            <span>System Rhythm:</span>
                            <span id="systemRhythm" style="font-weight: bold; color: #3498db;">-</span>
                        </div>
                        <div class="metric-item">
                            <span>Drum Efficiency:</span>
                            <span id="drumEfficiency" style="font-weight: bold; color: #27ae60;">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="buffer-section">
                    <h4 style="margin-top: 0; color: #2c3e50;">🛡️ Buffer Status Monitor</h4>
                    <p style="color: #666; margin-bottom: 15px;">Safety zones protecting the constraint from variability</p>
                    
                    <div class="buffer-visualization" id="bufferVisualization">
                        <!-- Buffer displays will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <div class="results-section" id="results-section" style="display: none;">
            <h3>📈 Simulation Results</h3>
            <div class="results-table" id="results"></div>
            <div class="chart-container">
                <h4>Scout Progress Visualization</h4>
                <canvas id="simChart" width="800" height="400"></canvas>
            </div>
        </div>

        <div class="insights">
            <h3>🧠 Theory of Constraints Insights</h3>
            <ul>
                <li><strong>The Constraint Dictates Throughput:</strong> The entire group can only move as fast as Herbie, regardless of how fast others can go</li>
                <li><strong>Variability Amplifies Problems:</strong> Random fluctuations in individual performance create cascading delays throughout the system</li>
                <li><strong>Local Optimization ≠ Global Optimization:</strong> Making fast scouts even faster won't improve overall group performance</li>
                <li><strong>Focus on the Bottleneck:</strong> The only way to improve system throughput is to help Herbie go faster or restructure the system</li>
                <li><strong>Buffer Management:</strong> The minimum gap represents necessary buffers that prevent total system breakdown</li>
            </ul>
        </div>
    </div>

    <script>
        let simChartInstance = null;
        let dbrEnabled = false;
        let currentStep = 0;
        let herbieSteps = [];

        function randn_bm(mean, std) {
            let u = 0, v = 0;
            while (u === 0) u = Math.random();
            while (v === 0) v = Math.random();
            return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v) * std + mean;
        }

        function updateDrumBeat(herbieSpeed, stepSize) {
            if (!dbrEnabled) return;
            
            // Update drum animation speed based on Herbie's performance
            const drumIcon = document.getElementById('drumIcon');
            const animationDuration = Math.max(0.5, 3 - (stepSize * 0.5)); // Faster beat for larger steps
            drumIcon.style.animationDuration = `${animationDuration}s`;
            
            if (stepSize > 0) {
                drumIcon.classList.add('drum-beat');
            } else {
                drumIcon.classList.remove('drum-beat');
            }
            
            // Update drum metrics
            document.getElementById('drumBeat').textContent = `${stepSize.toFixed(2)}m/step`;
            document.getElementById('systemRhythm').textContent = stepSize > 0 ? '🟢 Active' : '🔴 Blocked';
            
            // Calculate drum efficiency (moving vs blocked steps)
            herbieSteps.push(stepSize > 0 ? 1 : 0);
            const recentSteps = herbieSteps.slice(-10); // Last 10 steps
            const efficiency = recentSteps.length > 0 ? 
                (recentSteps.reduce((a, b) => a + b, 0) / recentSteps.length * 100).toFixed(1) : 0;
            document.getElementById('drumEfficiency').textContent = `${efficiency}%`;
        }

        function calculateBufferHealth(boy, boys, minGap) {
            if (!dbrEnabled) return 50;
            
            // Find who's ahead of this boy
            const sortedBoys = boys.slice().sort((a, b) => b.pos - a.pos);
            const currentIndex = sortedBoys.findIndex(b => b.name === boy.name);
            
            if (currentIndex === 0) return 100; // Leader has full buffer
            
            const boyAhead = sortedBoys[currentIndex - 1];
            const currentGap = boyAhead.pos - boy.pos;
            const bufferHealth = Math.min(100, Math.max(0, (currentGap / (minGap * 3)) * 100));
            
            return bufferHealth;
        }

        function updateBufferVisualization(boys, minGap) {
            if (!dbrEnabled) return;
            
            const bufferContainer = document.getElementById('bufferVisualization');
            bufferContainer.innerHTML = '';
            
            boys.forEach(boy => {
                const bufferHealth = calculateBufferHealth(boy, boys, minGap);
                const isConstraint = boy.name === 'Herbie';
                
                const bufferDiv = document.createElement('div');
                bufferDiv.className = `scout-buffer ${isConstraint ? 'herbie' : 'normal'}`;
                
                let healthClass = 'healthy';
                let healthIcon = '🟢';
                if (bufferHealth < 66) { healthClass = 'warning'; healthIcon = '🟡'; }
                if (bufferHealth < 33) { healthClass = 'critical'; healthIcon = '🔴'; }
                
                bufferDiv.innerHTML = `
                    <div class="buffer-label">${boy.name} ${isConstraint ? '(DRUM)' : ''}</div>
                    <div style="font-size: 2em; margin: 5px 0;">${isConstraint ? '🥁' : '🚶'}</div>
                    <div class="buffer-bar">
                        <div class="buffer-fill ${healthClass}" style="width: ${bufferHealth}%"></div>
                    </div>
                    <div style="font-size: 0.8em; margin-top: 5px;">
                        ${healthIcon} ${bufferHealth.toFixed(1)}% Buffer
                    </div>
                `;
                
                bufferContainer.appendChild(bufferDiv);
            });
        }

        // DBR Toggle functionality
        document.getElementById('dbrToggle').addEventListener('click', () => {
            dbrEnabled = !dbrEnabled;
            const button = document.getElementById('dbrToggle');
            const content = document.getElementById('dbrContent');
            
            if (dbrEnabled) {
                button.textContent = '🥁 Disable Drum-Buffer Visualization';
                button.style.background = 'linear-gradient(135deg, #27ae60 0%, #2ecc71 100%)';
                content.style.display = 'block';
            } else {
                button.textContent = '🥁 Enable Drum-Buffer Visualization';
                button.style.background = 'linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%)';
                content.style.display = 'none';
            }
        });

        function debugPopup(message) {
            return new Promise(resolve => {
                const overlay = document.createElement("div");
                overlay.id = "modal-overlay";
                
                const modal = document.createElement("div");
                modal.id = "modal-content";
                modal.innerHTML = `
                    <h3>🔍 Debug Step Analysis</h3>
                    <pre>${message}</pre>
                    <button onclick="this.closest('#modal-overlay').remove(); arguments[0].resolve();">Continue Simulation</button>
                `;
                
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                modal.querySelector("button").addEventListener("click", () => {
                    document.body.removeChild(overlay);
                    resolve();
                });
            });
        }

        function updateConstraintIndicators(boys) {
            const slowestBoy = boys.reduce((slowest, current) => 
                current.avg < slowest.avg ? current : slowest
            );
            
            document.querySelectorAll('.constraint-indicator').forEach(indicator => {
                indicator.remove();
            });
            
            const slowestCard = document.querySelector(`.scout-card.${slowestBoy.name.toLowerCase()}`);
            if (slowestCard) {
                const indicator = document.createElement('div');
                indicator.className = 'constraint-indicator';
                indicator.textContent = 'CONSTRAINT';
                slowestCard.style.position = 'relative';
                slowestCard.appendChild(indicator);
            }
        }

        function formatStepSize(stepSize) {
            return stepSize === 0 ? '<span style="color: #e74c3c;">❌ 0.00</span>' : `✅ ${stepSize}`;
        }

        function calculateSystemMetrics(boys, simResults) {
            const totalSteps = simResults.length;
            const herbie = boys.find(b => b.name === 'Herbie');
            const totalDistance = herbie.pos - herbie.positions[0];
            const avgThroughput = totalDistance / totalSteps;
            
            let totalWaitTime = 0;
            boys.forEach(boy => {
                simResults.forEach(step => {
                    if (parseFloat(step[boy.name].stepSize) === 0) {
                        totalWaitTime++;
                    }
                });
            });
            
            return {
                totalDistance: totalDistance.toFixed(2),
                avgThroughput: avgThroughput.toFixed(2),
                totalWaitTime: totalWaitTime,
                waitPercentage: ((totalWaitTime / (totalSteps * boys.length)) * 100).toFixed(1)
            };
        }

        document.getElementById('runSim').addEventListener('click', async () => {
            const button = document.getElementById('runSim');
            button.disabled = true;
            button.textContent = '🏃‍♂️ Simulation Running...';
            
            // Clear previous results
            document.getElementById('results').innerHTML = "";
            
            // Reset DBR tracking
            herbieSteps = [];
            currentStep = 0;
            
            // Show DBR visualization if enabled
            if (dbrEnabled) {
                document.getElementById('dbrVisualization').style.display = 'block';
            }
            
            // Destroy existing chart properly (Chrome fix)
            if (simChartInstance) {
                simChartInstance.destroy();
                simChartInstance = null;
            }
            
            // Get parameters
            const simSteps = parseInt(document.getElementById('sim_steps').value, 10);
            const minGap = parseFloat(document.getElementById('min_gap').value);
            const debugMode = document.getElementById('debug_mode').checked;

            // Initialize boys
            const boys = [
                { 
                    name: "Herbie", 
                    avg: parseFloat(document.getElementById('herbie_avg').value),
                    std: parseFloat(document.getElementById('herbie_std').value),
                    pos: parseFloat(document.getElementById('herbie_start').value),
                    positions: []
                },
                { 
                    name: "Dave", 
                    avg: parseFloat(document.getElementById('dave_avg').value),
                    std: parseFloat(document.getElementById('dave_std').value),
                    pos: parseFloat(document.getElementById('dave_start').value),
                    positions: []
                },
                { 
                    name: "Sean", 
                    avg: parseFloat(document.getElementById('sean_avg').value),
                    std: parseFloat(document.getElementById('sean_std').value),
                    pos: parseFloat(document.getElementById('sean_start').value),
                    positions: []
                },
                { 
                    name: "Ron", 
                    avg: parseFloat(document.getElementById('ron_avg').value),
                    std: parseFloat(document.getElementById('ron_std').value),
                    pos: parseFloat(document.getElementById('ron_start').value),
                    positions: []
                }
            ];

            // Record initial positions
            boys.forEach(boy => boy.positions.push(boy.pos));
            
            // Update constraint indicators
            updateConstraintIndicators(boys);

            let simResults = [];

            // Run simulation
            for (let step = 1; step <= simSteps; step++) {
                currentStep = step;
                let stepRecord = { step };
                let herbieStepSize = 0;
                
                // Sort boys by position (front to back)
                const order = boys.slice().sort((a, b) => b.pos - a.pos);
                
                for (let i = 0; i < order.length; i++) {
                    const boy = order[i];
                    
                    // Calculate potential step
                    let calculatedStep = randn_bm(boy.avg, boy.std);
                    if (calculatedStep < 0) calculatedStep = 0;
                    
                    // Check if boy can move without violating min gap
                    let willProgress = true;
                    if (i > 0) {
                        const boyAhead = order[i - 1];
                        const newPosition = boy.pos + calculatedStep;
                        if ((boyAhead.pos - newPosition) < minGap) {
                            willProgress = false;
                        }
                    }
                    
                    // Debug message
                    const debugMsg = `Step: ${step}\nBoy: ${boy.name}\nCurrent Position: ${boy.pos.toFixed(2)}m\nCalculated Step: ${calculatedStep.toFixed(2)}m\nWould be at: ${(boy.pos + calculatedStep).toFixed(2)}m\n${i > 0 ? `Boy ahead (${order[i-1].name}): ${order[i-1].pos.toFixed(2)}m\nGap would be: ${(order[i-1].pos - (boy.pos + calculatedStep)).toFixed(2)}m\nMin gap required: ${minGap}m\n` : ''}Result: ${willProgress ? 'PROGRESSING ✅' : 'BLOCKED ❌ (insufficient gap)'}`;
                    
                    if (debugMode) {
                        await debugPopup(debugMsg);
                    } else {
                        console.log(debugMsg);
                    }
                    
                    // Move boy if allowed
                    const actualStep = willProgress ? calculatedStep : 0;
                    boy.pos += actualStep;
                    
                    // Track Herbie's step for drum visualization
                    if (boy.name === 'Herbie') {
                        herbieStepSize = actualStep;
                    }
                    
                    stepRecord[boy.name] = {
                        stepSize: actualStep.toFixed(2),
                        pos: boy.pos.toFixed(2)
                    };
                }
                
                // Update DBR visualization
                updateDrumBeat(boys.find(b => b.name === 'Herbie').avg, herbieStepSize);
                updateBufferVisualization(boys, minGap);
                
                // Record positions
                boys.forEach(boy => boy.positions.push(boy.pos));
                simResults.push(stepRecord);
                
                // Small delay for visual effect
                if (!debugMode) {
                    await new Promise(resolve => setTimeout(resolve, dbrEnabled ? 800 : 50));
                }
            }

            // Display results table
            const table = document.createElement('table');
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `
                <th>Step</th>
                ${boys.map(boy => `<th style="color: ${getScoutColor(boy.name)}">${boy.name}<br>Position (m)</th><th style="color: ${getScoutColor(boy.name)}">${boy.name}<br>Step (m)</th>`).join('')}
            `;
            table.appendChild(headerRow);
            
            simResults.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${record.step}</strong></td>
                    ${boys.map(boy => `<td>${record[boy.name].pos}</td><td>${formatStepSize(record[boy.name].stepSize)}</td>`).join('')}
                `;
                table.appendChild(row);
            });
            
            document.getElementById('results').appendChild(table);

            // Calculate and display system metrics
            const metrics = calculateSystemMetrics(boys, simResults);
            const metricsDiv = document.createElement('div');
            metricsDiv.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h4>📊 System Performance Metrics</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div><strong>Total Distance (Herbie):</strong> ${metrics.totalDistance}m</div>
                        <div><strong>Average Throughput:</strong> ${metrics.avgThroughput}m/step</div>
                        <div><strong>Total Wait Instances:</strong> ${metrics.totalWaitTime}</div>
                        <div><strong>System Idle Time:</strong> ${metrics.waitPercentage}%</div>
                    </div>
                </div>
            `;
            document.getElementById('results').appendChild(metricsDiv);

            // Calculate max position for proper Y-axis scaling (Chrome fix)
            const maxPosition = Math.max(...boys.map(boy => Math.max(...boy.positions))) + 5;

            // Clear canvas context (Chrome fix)
            const ctx = document.getElementById('simChart').getContext('2d');
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            const datasets = boys.map(boy => ({
                label: `${boy.name} ${boy.name === 'Herbie' ? '(Constraint)' : ''}`,
                data: boy.positions.map((pos, i) => ({ x: i, y: pos })),
                borderColor: getScoutColor(boy.name),
                backgroundColor: getScoutColor(boy.name) + '20',
                borderWidth: boy.name === 'Herbie' ? 4 : 2,
                pointRadius: boy.name === 'Herbie' ? 5 : 3,
                pointBackgroundColor: getScoutColor(boy.name),
                fill: false,
                tension: 0.1
            }));

            simChartInstance = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    animation: {
                        duration: 0 // Disable animations for Chrome stability
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: { display: true, text: 'Simulation Step' },
                            ticks: { 
                                stepSize: 1,
                                maxTicksLimit: 20 // Prevent tick overflow
                            },
                            min: 0,
                            max: simSteps + 1 // Add buffer
                        },
                        y: {
                            title: { display: true, text: 'Position (meters)' },
                            beginAtZero: true,
                            max: maxPosition, // THE FIX: Explicit max value
                            ticks: {
                                maxTicksLimit: 10 // Prevent Y-axis tick explosion
                            }
                        }
                    },
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        title: {
                            display: true,
                            text: 'Scout Progress Over Time - Theory of Constraints Visualization',
                            font: { size: 16 }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    // Chrome-specific fixes
                    devicePixelRatio: 1, // Prevent high-DPI scaling issues
                    interaction: {
                        intersect: false
                    }
                }
            });

            // Force chart resize after creation (Chrome workaround)
            setTimeout(() => {
                if (simChartInstance) {
                    simChartInstance.resize();
                }
            }, 100);

            // Show results section
            document.getElementById('results-section').style.display = 'block';
            document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });

            // Reset button
            button.disabled = false;
            button.textContent = '🚀 Start Scout Hike Simulation';
        });

        function getScoutColor(name) {
            const colors = {
                'Herbie': '#e74c3c',
                'Dave': '#3498db',
                'Sean': '#f39c12',
                'Ron': '#27ae60'
            };
            return colors[name] || '#7f8c8d';
        }

        // Put Herbie in Front button logic
        document.getElementById('putHerbieFirst').addEventListener('click', () => {
            // Set optimal positions according to ToC principle
            // Herbie (slowest) goes to front, others sorted by speed from slowest to fastest
            document.getElementById('herbie_start').value = 9;   // Herbie leads
            document.getElementById('dave_start').value = 6;     // Dave (5.5 km/h) 
            document.getElementById('sean_start').value = 3;     // Sean (6.0 km/h)
            document.getElementById('ron_start').value = 0;      // Ron (6.2 km/h) at back
            
            // Visual feedback
            const button = document.getElementById('putHerbieFirst');
            const originalText = button.textContent;
            button.textContent = '✅ Formation Optimized!';
            button.style.background = 'linear-gradient(135deg, #27ae60 0%, #2ecc71 100%)';
            
            // Reset visual feedback after 2 seconds
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = 'linear-gradient(135deg, #27ae60 0%, #229954 100%)';
            }, 2000);
            
            // Highlight the changed fields
            ['herbie_start', 'dave_start', 'sean_start', 'ron_start'].forEach(id => {
                const input = document.getElementById(id);
                input.style.borderColor = '#27ae60';
                input.style.borderWidth = '3px';
                setTimeout(() => {
                    input.style.borderColor = '#e1e8ed';
                    input.style.borderWidth = '2px';
                }, 2000);
            });
        });

        // Initialize constraint indicators on page load
        document.addEventListener('DOMContentLoaded', () => {
            const boys = [
                { name: "Herbie", avg: 4.0 },
                { name: "Dave", avg: 5.5 },
                { name: "Sean", avg: 6.0 },
                { name: "Ron", avg: 6.2 }
            ];
            updateConstraintIndicators(boys);
        });
    </script>
</body>
</html>